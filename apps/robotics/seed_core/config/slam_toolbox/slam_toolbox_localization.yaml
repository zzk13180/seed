# ================================================================================
# 文件名: slam_toolbox_localization.yaml
# 描  述: SLAM Toolbox 定位模式配置参数
#
# 功能说明:
#   此配置文件用于 slam_toolbox 的定位模式 (localization_slam_toolbox_node)
#   机器人在已知地图中进行自我定位，不会修改地图
#
# 使用场景:
#   - 导航模式下的持续定位
#   - 在已建好的地图中运行
#
# 作者: Seed Robotics Team
# 版本: 2.0.0
# ================================================================================

# ================================================================================
# 优化求解器配置
# ================================================================================
# 使用 Ceres Solver 进行位姿图优化
# Ceres 是 Google 开发的高效非线性最小二乘优化库
solver_plugin: solver_plugins::CeresSolver

# 线性求解器类型
# 可选值:
#   - SPARSE_NORMAL_CHOLESKY: 稀疏 Cholesky 分解，适合中小规模问题
#   - SPARSE_SCHUR: 稀疏 Schur 补，适合 SLAM 问题
#   - ITERATIVE_SCHUR: 迭代 Schur 补，适合大规模问题
#   - CGNR: 共轭梯度法
ceres_linear_solver: SPARSE_SCHUR

# 预条件器类型（用于迭代求解器）
# 可选值: JACOBI, IDENTITY, SCHUR_JACOBI
ceres_preconditioner: SCHUR_JACOBI

# 信赖域策略
# 可选值:
#   - LEVENBERG_MARQUARDT: LM 算法，更稳定
#   - DOGLEG: Dogleg 算法，某些情况下更快
ceres_trust_strategy: LEVENBERG_MARQUARDT

# Dogleg 策略类型
# 可选值: TRADITIONAL_DOGLEG, SUBSPACE_DOGLEG
ceres_dogleg_type: SUBSPACE_DOGLEG

# 损失函数（用于处理异常值）
# 可选值:
#   - None: 不使用损失函数
#   - HuberLoss: Huber 损失，对异常值更鲁棒
#   - CauchyLoss: Cauchy 损失，异常值抑制更强
ceres_loss_function: None

# ================================================================================
# ROS 话题和坐标系配置
# ================================================================================
# 里程计坐标系名称
# 通常由底盘驱动或里程计节点发布
odom_frame: odom

# 地图坐标系名称
# SLAM 系统发布 map -> odom 变换
map_frame: map

# 机器人基座坐标系名称
# 激光雷达数据参考此坐标系
base_frame: base_footprint

# 激光雷达话题名称
# 订阅此话题获取扫描数据用于定位
scan_topic: /scan

# 运行模式
# mapping: 建图模式
# localization: 定位模式（当前配置）
mode: localization

# 启动时的初始位姿 [x, y, theta]
# 用于在地图中的起始定位
map_start_pose: [0.0, 0.0, 0.0]

# ================================================================================
# 调试与日志配置
# ================================================================================
# 是否启用调试日志
# 开启后会输出大量调试信息，仅在问题排查时使用
debug_logging: false

# ================================================================================
# 扫描处理配置
# ================================================================================
# 扫描节流系数
# 每 N 次扫描处理 1 次，用于降低计算负载
# 1 表示处理每一帧扫描
throttle_scans: 1

# map->odom 变换发布周期（秒）
# 0 表示不发布变换
# 建议值: 0.02 (50Hz)
transform_publish_period: 0.02

# 地图更新间隔（秒）
# 控制发布更新地图的频率
# 定位模式下可以设置较大值，因为不需要频繁更新地图
map_update_interval: 5.0

# 地图分辨率（米/像素）
# 必须与加载的地图分辨率匹配
resolution: 0.05

# 激光最大有效距离（米）
# 超过此距离的激光数据将被忽略
max_laser_range: 20.0

# 扫描处理最小时间间隔（秒）
# 用于限制处理频率
minimum_time_interval: 0.5

# TF 查找超时时间（秒）
# 查找坐标变换时的最大等待时间
transform_timeout: 0.2

# TF 缓冲区持续时间（秒）
# 存储历史 TF 数据的时长
tf_buffer_duration: 30.0

# 堆栈大小（字节）
# 用于支持大型地图的序列化/反序列化
stack_size_to_use: 40000000

# ================================================================================
# 扫描匹配配置
# ================================================================================
# 是否启用扫描匹配
# 扫描匹配用于精确估计机器人位姿
use_scan_matching: true

# 是否使用扫描重心
# 使用扫描数据的重心作为参考点
use_scan_barycenter: true

# 触发新扫描处理的最小移动距离（米）
# 机器人移动超过此距离才处理新扫描
minimum_travel_distance: 0.5

# 触发新扫描处理的最小航向变化（弧度）
# 机器人旋转超过此角度才处理新扫描
minimum_travel_heading: 0.5

# 扫描缓冲区大小
# 保存最近 N 帧扫描用于匹配
scan_buffer_size: 3

# 扫描缓冲区最大距离（米）
# 超过此距离的扫描将从缓冲区移除
scan_buffer_maximum_scan_distance: 10.0

# 链接匹配最小响应阈值（精细搜索）
# 响应值低于此阈值的匹配将被拒绝
link_match_minimum_response_fine: 0.1

# 链接扫描最大距离（米）
# 用于扫描链接的最大搜索距离
link_scan_maximum_distance: 1.5

# ================================================================================
# 回环闭合配置
# ================================================================================
# 是否启用回环闭合检测
# 回环闭合可以消除累积误差，提高定位精度
do_loop_closing: true

# 回环搜索最小链长度
# 至少需要此数量的扫描才开始搜索回环
loop_match_minimum_chain_size: 3

# 粗搜索最大方差阈值
# 方差超过此值的匹配将被拒绝
loop_match_maximum_variance_coarse: 3.0

# 粗搜索最小响应阈值
loop_match_minimum_response_coarse: 0.35

# 精细搜索最小响应阈值
loop_match_minimum_response_fine: 0.45

# ================================================================================
# 相关性搜索参数（扫描匹配）
# ================================================================================
# 搜索空间维度（米）
# 扫描匹配时的搜索范围
correlation_search_space_dimension: 0.5

# 搜索空间分辨率（米）
# 搜索网格的步长
correlation_search_space_resolution: 0.01

# 多模态涂抹偏差
# 用于平滑响应曲面，处理多峰情况
correlation_search_space_smear_deviation: 0.1

# ================================================================================
# 回环闭合搜索参数
# ================================================================================
# 回环搜索空间维度（米）
# 回环检测时的搜索范围，通常比普通匹配更大
loop_search_space_dimension: 8.0

# 回环搜索空间分辨率（米）
loop_search_space_resolution: 0.05

# 回环搜索涂抹偏差
loop_search_space_smear_deviation: 0.03

# 回环搜索最大距离（米）
# 只在此距离内搜索可能的回环
loop_search_maximum_distance: 5.0

# ================================================================================
# 扫描匹配器参数
# ================================================================================
# 距离方差惩罚系数
# 用于惩罚匹配位置与里程计位置的偏差
distance_variance_penalty: 0.5

# 角度方差惩罚系数
# 用于惩罚匹配角度与里程计角度的偏差
angle_variance_penalty: 1.0

# 精细搜索角度偏移（弧度）
# 精细匹配时的角度搜索范围
fine_search_angle_offset: 0.00349

# 粗搜索角度偏移（弧度）
# 粗匹配时的角度搜索范围
coarse_search_angle_offset: 0.349

# 粗搜索角度分辨率（弧度）
# 粗匹配时的角度步长
coarse_angle_resolution: 0.0349

# 最小角度惩罚
# 防止角度惩罚过小导致数值问题
minimum_angle_penalty: 0.9

# 最小距离惩罚
# 防止距离惩罚过小导致数值问题
minimum_distance_penalty: 0.5

# 是否启用响应扩展
# 当找不到有效匹配时，自动扩大搜索范围
use_response_expansion: true
